#include "LinkedList.h"

typedef struct sListNode
{
  void* Data;
  struct sListNode* Next;
} sListNode;

typedef struct sLinkedList
{
  size_t Size;
  sListNode* Head;
  sListNode* Tail;
  size_t ElementSize;
  void (*EraseFun)(void*);
} sLinkedList;

typedef struct sListIterator
{
  sListNode** Prev;
  sListNode** Current;
  sListNode** Next;
  sLinkedList* List;
} sListIterator;

void listInitialize(sLinkedList** List, size_t ElementSize,void(*EraseFun)(void*))
{
  if(*List != NULL)
    return;
  *List = malloc(sizeof(sLinkedList));
  (*List)->Size = 0;
  (*List)->Head = NULL;
  (*List)->Tail = NULL;
  (*List)->ElementSize = ElementSize;
  (*List)->EraseFun = EraseFun;
}

void listPushBack(sLinkedList* List, void* Data)
{
  if(List == NULL)
    return;
  sListNode* Node = malloc(sizeof(sListNode));
  Node->Data = malloc(List->ElementSize);
  memcpy(Node->Data, Data, List->ElementSize);
  Node->Next = NULL;
  if(List->Head == NULL)
    List->Head = List->Tail = Node;
  else
  {
    List->Tail->Next = Node;
    List->Tail = Node;
  }
  List->Size++;
}

void listPushFront(sLinkedList* List, void* Data)
{
  if(List == NULL)
    return;
  sListNode* Node = malloc(sizeof(sListNode));
  memcpy(Node->Data, Data, List->ElementSize);
  Node->Next = List->Head;
  if(List->Head == NULL)
    List->Head = List->Tail = Node;
  else
    List->Head = Node;
  List->Size++;
}

void listInsert(sListIterator* Iterator, void* Data)
{
  if(*(Iterator->Current) == NULL)
    listPushBack(Iterator->List, Data);
  else
  {
    sListNode* Node = malloc(sizeof(sListNode));
    Node->Data = malloc(Iterator->List->ElementSize);
    memcpy(Node->Data, Data, Iterator->List->ElementSize);
    Node->Next = *(Iterator->Next);
    (*(Iterator->Current))->Next = Node;
  }
}

void listErase(sListIterator* Iterator)
{
  if(*(Iterator->Current) == NULL)
    return;
  void* Data = (*(Iterator->Current))->Data;
  free(*(Iterator->Current));
  if(Iterator->List->EraseFun != NULL)
    (*Iterator->List->EraseFun)(Data);
  free(Data);
  Iterator->Current = Iterator->Next;
  Iterator->Next = &((*(Iterator->Next))->Next);  
  Iterator->List->Size--;
}

void* listGet(sListIterator* Iterator)
{
  if(*(Iterator->Current) == NULL)
    return 0;
  void* Data = (*(Iterator->Current))->Data;
  return Data;
}

sListIterator* listHead(sLinkedList* List)
{
  sListIterator* ret = malloc(sizeof(sListIterator));
  ret->List = List;
  ret->Prev = NULL;
  ret->Current = &(List->Head);
  ret->Next = &(List->Head->Next);
  return ret;
}

size_t listSize(sLinkedList* List)
{
  if(List == NULL)
    return 0;
  return List->Size;
}

int listEmpty(sLinkedList* List)
{
  if(List == NULL)
    return 0;
  return (List->Size == 0) ? 1 : 0;
}

void listClear(sLinkedList* List)
{
  if(List == NULL)
    return;
  sListIterator* it = listHead(List);
  while(!listIteratorEnd(it))
    listErase(it);
}

void listIteratorNext(sListIterator* Iterator)
{
  if(*(Iterator->Current) == NULL)
    return;
  Iterator->Prev = Iterator->Current;
  Iterator->Current = Iterator->Next;
  Iterator->Next = &((*(Iterator->Next))->Next);
}

int listIteratorEnd(sListIterator* Iterator)
{
  return(*Iterator->Current == NULL) ? 1 : 0;
}
